name: Daily Garmin Update

on:
    schedule:
        # Runs at 10:15 UTC (5:15 AM EST) every day
        - cron: "15 10 * * *"
    workflow_dispatch: # Allows manual testing

permissions:
    contents: write

jobs:
    update-garmin:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Install Dependencies
              run: |
                  pip install garminconnect

            - name: Fetch Garmin Data
              env:
                  GARMIN_EMAIL: ${{ secrets.GARMIN_EMAIL }}
                  GARMIN_PASSWORD: ${{ secrets.GARMIN_PASSWORD }}
              run: |
                  python dashboard_exporter.py

            - name: Commit and Push Changes
              run: |
                  git config --global user.name "GitHub Actions Bot"
                  git config --global user.email "actions@github.com"
                  git add dashboard_data.json
                  # Only commit if there are changes
                  if [[ -n $(git status -s dashboard_data.json) ]]; then
                    git commit -m "Daily Garmin update - $(date +%Y-%m-%d)"
                    git push
                  else
                    echo "No changes to dashboard_data.json"
                  fi
