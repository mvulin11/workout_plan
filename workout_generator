import json
import smtplib
import os
import datetime
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import google.generativeai as genai

# --- CONFIGURATION & SCIENCE (The "Why") ---
# We use Linear Periodization: Volume decreases, Intensity increases over 4 weeks.
# Week 1: Hypertrophy/Accumulation (Higher reps, moderate weight)
# Week 2: Strength/Intensification (Moderate reps, heavier)
# Week 3: Peaking/Realization (Low reps, heavy)
# Week 4: Deload (Reset fatigue)

PERIODIZATION_MODELS = {
    1: {"name": "Accumulation", "sets": 4, "reps": "10-12", "intensity": 0.70, "rest": "60-90s"},
    2: {"name": "Intensification", "sets": 3, "reps": "6-8", "intensity": 0.80, "rest": "2-3 mins"},
    3: {"name": "Realization", "sets": 3, "reps": "3-5", "intensity": 0.875, "rest": "3-5 mins"},
    4: {"name": "Deload", "sets": 2, "reps": "10", "intensity": 0.50, "rest": "60s"}
}

def load_profile():
    """Loads the user's current stats and progress."""
    try:
        with open('user_profile.json', 'r') as f:
            return json.load(f)
    except FileNotFoundError:
        print("Error: user_profile.json not found.")
        return None

def calculate_weight(one_rep_max, intensity):
    """Calculates working weight rounded to nearest 5lbs."""
    weight = one_rep_max * intensity
    return round(weight / 5) * 5

def get_ai_cues(exercise_name, weight, phase_name, goal):
    """Fetches dynamic cues from Gemini API."""
    api_key = os.environ.get('GEMINI_API_KEY')
    if not api_key:
        return "Control eccentric, explosive concentric. (API Key missing)"

    try:
        genai.configure(api_key=api_key)
        # Using a standard stable model alias. 
        # If the user specifically needs a preview model, this can be updated.
        model = genai.GenerativeModel('gemini-3-pro-preview') 
        
        prompt = f"""
        Give me a very short, punchy, 1-sentence technical cue for the exercise '{exercise_name}'.
        Context:
        - Weight: {weight}
        - Phase: {phase_name}
        - User Goal: {goal}
        
        If the weight is heavy, focus on bracing and safety.
        If the phase is 'Hypertrophy', focus on the stretch and squeeze.
        If the phase is 'Power', focus on speed.
        Keep it under 15 words. No fluff.
        """
        
        response = model.generate_content(prompt)
        return response.text.strip()
    except Exception as e:
        print(f"Gemini API Error: {e}")
        return "Focus on perfect form."

def generate_weekly_plan(profile):
    """Generates the specific workouts for the upcoming week."""
    
    # Determine where we are in the cycle
    cycle_week = (profile['current_week'] - 1) % 4 + 1
    phase = PERIODIZATION_MODELS[cycle_week]
    
    plan_html = f"""
    <html>
    <body>
        <h2>ðŸ’ª Automated Weekly Protocol: Week {profile['current_week']}</h2>
        <p><strong>Phase:</strong> {phase['name']}</p>
        <p><strong>Goal:</strong> {profile['primary_goal']}</p>
        <hr>
    """

    # Loop through workout days defined in profile
    for day in profile['schedule']:
        plan_html += f"<h3>{day['day_name']} - {day['focus']}</h3>"
        plan_html += "<table border='1' cellpadding='5' style='border-collapse: collapse; width: 100%;'>"
        plan_html += "<tr style='background-color: #f2f2f2;'><th>Exercise</th><th>Sets</th><th>Reps</th><th>Weight (lbs)</th><th>Rest</th><th>Cues</th></tr>"
        
        for exercise_name in day['exercises']:
            # Find the 1RM for this exercise if it exists (for main compounds)
            # Default to RPE if no 1RM is tracked
            exercise_data = profile['maxes'].get(exercise_name)
            
            weight_str = "RPE 7-8" # Default for accessories
            
            if exercise_data:
                # Progressive Overload Logic: 
                # We add a small micro-load (e.g., 2.5%) for every completed block (4 weeks)
                cycle_count = (profile['current_week'] - 1) // 4
                adjusted_max = exercise_data * (1 + (cycle_count * 0.025)) 
                
                working_weight = calculate_weight(adjusted_max, phase['intensity'])
                weight_str = f"{working_weight} lbs"
            
            # Call Gemini for dynamic cues
            cues = get_ai_cues(exercise_name, weight_str, phase['name'], profile['primary_goal'])

            plan_html += f"""
            <tr>
                <td>{exercise_name}</td>
                <td>{phase['sets']}</td>
                <td>{phase['reps']}</td>
                <td>{weight_str}</td>
                <td>{phase['rest']}</td>
                <td><small>{cues}</small></td>
            </tr>
            """
        plan_html += "</table><br>"

    plan_html += """
        <p><em>Generated by Python Automation. Stay Hard.</em></p>
    </body>
    </html>
    """
    
    return plan_html

def send_email(content, recipient_email):
    """Sends the plan via email."""
    sender_email = os.environ.get('EMAIL_USER')
    sender_password = os.environ.get('EMAIL_PASS')
    
    if not sender_email or not sender_password:
        print("Skipping email: Credentials not set.")
        # For testing, just write to file
        with open('weekly_plan.html', 'w') as f:
            f.write(content)
        return

    msg = MIMEMultipart()
    msg['Subject'] = f"Your Training Plan"
    msg['From'] = sender_email
    msg['To'] = recipient_email
    msg.attach(MIMEText(content, 'html'))

    try:
        # Assuming Gmail - requires App Password
        with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
            server.login(sender_email, sender_password)
            server.send_message(msg)
        print("Email sent successfully.")
    except Exception as e:
        print(f"Failed to send email: {e}")

def update_week(profile):
    """Increments the week number in the JSON file."""
    profile['current_week'] += 1
    with open('user_profile.json', 'w') as f:
        json.dump(profile, f, indent=4)

if __name__ == "__main__":
    user_profile = load_profile()
    if user_profile:
        print(f"Generating plan for Week {user_profile['current_week']}...")
        workout_plan = generate_weekly_plan(user_profile)
        
        # In a real GitHub Action, you would store secrets in the repo settings
        recipient = "your_email@example.com" 
        send_email(workout_plan, recipient)
        
        # Auto-increment week for next Sunday
        update_week(user_profile)
        print("Week updated. Process complete.")
